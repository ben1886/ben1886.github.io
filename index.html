<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tempo Retention Test</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- WebChucK -->
  <script type="module" defer>
    import { Chuck } from 'https://cdn.jsdelivr.net/npm/webchuck/+esm';

    let fname, lname; // To store user inputs
    let results = {}; // To store test results
    let isTestActive = false;

    // Initialize WebChucK
    let theChuck = null;
    async function initChuck() {
      if (!theChuck) {
        theChuck = await Chuck.init([]);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const startButton = document.getElementById("startTest");
      const stopButton = document.getElementById("stopTest");
      const form = document.getElementById("userForm");

      // Submit form and proceed to test
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        fname = document.getElementById("fname").value.trim();
        lname = document.getElementById("lname").value.trim();
        document.getElementById("intro").classList.add("d-none");
        document.getElementById("test").classList.remove("d-none");
      });

      // Start the test
      startButton.addEventListener("click", async () => {
        await initChuck();
        isTestActive = true;
        runTest();
      });

      // Stop the test
      stopButton.addEventListener("click", () => {
        isTestActive = false;
        theChuck.removeLastCode();
      });
    });

    function runTest() {
      theChuck.runCode(`
        SinOsc leftOsc => dac.chan(0);
        SinOsc rightOsc => dac.chan(1);
        0.5 => leftOsc.gain;
        0.5 => rightOsc.gain;

        global Event KeyE, KeyO, sectionDone;
        global time leftTaps[16], rightTaps[16];
        global int leftCount = 0, rightCount = 0;
        global float avgLeft, avgRight;

        fun float calculateAverage(time[] taps, int count) {
          time total;
          0 => total;
          for (int i = 0; i < count - 1; i++) {
            total += taps[i + 1] - taps[i];
          }
          return total / samp / (count - 1);
        }

        spork ~ (function() {
          while (true) {
            KeyE => now;
            if (leftCount < leftTaps.size()) {
              now => leftTaps[leftCount++];
            }
          }
        })();

        spork ~ (function() {
          while (true) {
            KeyO => now;
            if (rightCount < rightTaps.size()) {
              now => rightTaps[rightCount++];
            }
          }
        })();

        for (int section = 0; section < 3; section++) {
          if (section == 0) {
            330 => leftOsc.freq;
            660 => rightOsc.freq;
          } else if (section == 1) {
            440 => leftOsc.freq;
            880 => rightOsc.freq;
          } else {
            550 => leftOsc.freq;
            1100 => rightOsc.freq;
          }

          for (int i = 0; i < 15; i++) {
            1 => leftOsc.gain => rightOsc.gain;
            0.3::second => now;
            0 => leftOsc.gain => rightOsc.gain;
            0.3::second => now;
          }

          sectionDone.broadcast();
          sectionDone => now;
        }

        avgLeft = calculateAverage(leftTaps, leftCount);
        avgRight = calculateAverage(rightTaps, rightCount);
      `);
    }

    function saveResults() {
      results = {
        fname: fname,
        lname: lname,
        results: {
          left: 0, // Replace with avgLeft
          right: 0, // Replace with avgRight
        },
      };

      const blob = new Blob([JSON.stringify(results, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `tempo_results_${fname}_${lname}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</head>
<body>
  <div class="container my-4">
    <!-- Intro Section -->
    <div id="intro">
      <h1 class="text-center">Tempo Retention Test</h1>
      <p class="text-center text-danger"><strong>Warning:</strong> Use headphones for the best experience.</p>
      <form id="userForm" class="my-4">
        <div class="mb-3">
          <label for="fname" class="form-label">First Name</label>
          <input type="text" class="form-control" id="fname" required>
        </div>
        <div class="mb-3">
          <label for="lname" class="form-label">Last Name</label>
          <input type="text" class="form-control" id="lname" required>
        </div>
        <button type="submit" class="btn btn-primary">Start</button>
      </form>
    </div>

    <!-- Test Section -->
    <div id="test" class="d-none">
      <h2 class="text-center">Test in Progress</h2>
      <p class="text-center">Press the "E" key for left ear taps and "O" key for right ear taps.</p>
      <div class="d-flex justify-content-center gap-2">
        <button id="startTest" class="btn btn-success">Start Test</button>
        <button id="stopTest" class="btn btn-danger">Stop Test</button>
      </div>
      <button onclick="saveResults()" class="btn btn-secondary mt-4">Save Results</button>
    </div>
  </div>
</body>
</html>
