
<!DOCTYPE html>
<html>
  <head>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" defer>
      // import your audio engine so you can generate the sweep
      import { Chuck } from 'https://cdn.jsdelivr.net/npm/webchuck/+esm';

      //This code starts the test
      document.getElementById('action').addEventListener('click', async () => {
        // Initialize default ChucK object, if not already initialized
        window.theChuck ??= await Chuck.init([]);
        // Run ChucK code
        theChuck.runCode(`
          SinOsc sin => dac;
          1000 => sin.freq;
          minute => now;
        `);
      });

      //This code stops the test
      document.getElementById('stopTest').addEventListener('click', async () => {
        theChuck.removeLastCode();
      });

      // This code runs the actual test
      document.getElementById('actualTest').addEventListener('click', async () => {
        theChuck.startListeningForEvent("done", doneCallback);
        theChuck.startListeningForEvent("save", saveCallback);
        theChuck.runCode(`
            global Event done;
            global Event save;
            global Event keypressed;
            global float total;
            global float total2;
            global float total3;
            SinOsc sin => dac;

            220 => sin.freq;

            int counter2;
            int counter3;

            function float test(int ref){

            int counter;
            time times[0];
            float t;

              repeat(8){
                1 => sin.gain;
                ref::ms => now;
                0 => sin.gain;
                ref::ms => now;
              }

              while(counter < 16){
                times << now;
                keypressed => now;
                times << now;
                counter++;
              }

              for(int i; i < times.size(); i + 2 => i){
                (times[i+1]-times[i])/samp +=> t;
              }
              t/32.0 => t;
              return t;
            }

            test(417) => total;
            test(750) => total2;
            test(250) => total3;

            done.broadcast();
            second => now;
            save.broadcast();
          `);
        });

    </script>
  </head>
  <body>
  <script>

      let result = 0;
      let result2 = 0;
      let result3 = 0;
      let fname
      let lname

        // This section will allow to get user information, feel free to add more questions depending on the type of test you want to run
      const element = document.createElement('div');
      element.innerHTML = `
      <div class="container-md mt-3 border" id="intro">
        <p class="h1 text-center" >How well do you recall tempo?</p><br><br>
        <p class="h4 text-center"><b>WARNING</b> use earpods or headphones</p>
        <p class="h5 text-center">Take the volume of your computer all the way down, then press the "Start Test" button and increase the volume until you reach a confortable level.</p><br><br>
        <div class="row">
        <div class="col"></div>
        <div class="col"><button id="action" class="btn btn-primary">Start Test</button><button id="stopTest" class="btn btn-primary">Stop Test</button><br><br><br><br></div>
        <div class="col"></div>
        </div>

        <div class="input-group input-group-md mb-3">
            <form id="myForm">
            <label for="fname">First name:</label>
                <input type="text" id="fname" name="fname" required><br><br>
                <label for="lname">Last name:</label>
                <input type="text" id="lname" name="lname" required><br><br>
                <button type="submit" class="btn btn-primary" onclick="sendForm(); intro.remove(); document.body.appendChild(test); document.getElementById('frame').appendChild(document.getElementById('actualTest')) ;document.getElementById('actualTest').style.cssText = 'display:inline'">Submit</button>
            </form>
            </div>
        </div>
      `;

      document.body.appendChild(element);



    function sendForm(){
      fname = document.getElementById('fname').value
      lname = document.getElementById('lname').value
    }



    const test = document.createElement('div');
      test.innerHTML = `
        <div class="container-md mt-3 border" id="test" >
        <p class="h4 text-center"><b>WARNING</b> After you hit start don't change the volume of your device</p><br><br>
        <p class="h5 text-center">When you press 'start' you will hear eight ticks.
When the last tick stops use the space bar to keep tapping at the same tempo.
After 16 taps the computer tick will start again at a new tempo.
Repeat three times.
The experiment will end by itself after the third set. </p><br><br>
        <div class="row" id="frame">
        <div class="col"></div>
        <div class="col"></div>
        </div>
        </div>
      `;

      const intro = document.getElementById("intro");

      document.addEventListener("keypress", function(event) {
        if (event.code === 'Space') {
          theChuck.broadcastEvent("keypressed");
        }
		if (event.code === 'W') {
          theChuck.broadcastEvent("keypressed");
        }
		console.log (event.code)
      });


      const JSONToFile = (obj, filename) => {
        const blob = new Blob([JSON.stringify(obj, null, 2)], {
            type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

    function doneCallback() {
        theChuck.getFloat("total").then( function(val) {
            result = val;
            console.log(result);
        });
        theChuck.getFloat("total2").then( function(val) {
            result2 = val;
            console.log(result2);
        });
        theChuck.getFloat("total3").then( function(val) {
            result3 = val;
            console.log(result3);
        });
    }

    function saveCallback() {
      test.innerHTML = `
        <div class="container-md mt-3 border" id="test" >
        <p class="h4 text-center"><b>Thank you</b><br>Upload you results (downloaded as a .json) to canvas </p><br><br>
        </div>
      `;
      JSONToFile(
      { name: fname,
        lastName: lname,
        reference1: 18389.7,
        result1: result,
        reference2: 33075,
        result2: result2,
        reference3: 11025,
        result3: result3,
      }, 'tempo_recall'+fname+lname
    );
    }


    </script>
    <div class="col"><button id="actualTest" style="display:none" onclick="this.disabled=true">Start Test</button></div>
  </body>
</html>

