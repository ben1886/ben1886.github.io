<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webchuck/dist/webchuck.js"></script>
    <script type="module">
    import { Chuck } from 'https://cdn.jsdelivr.net/npm/webchuck/+esm';

    let theChuck;
    let left1 = 0, left2 = 0, left3 = 0, right1 = 0, right2 = 0, right3 = 0;
    let fname, lname;

    async function initChuck() {
        theChuck = await Chuck.init([]);
        console.log("Chuck initialized");
    }

    async function startTest() {
        if (!theChuck) {
            console.error("Chuck not initialized");
            return;
        }
        await theChuck.runCode(`
            SinOsc sin => dac;
            1000 => sin.freq;
            0.5 => sin.gain;
            minute => now;
        `);
        console.log("Test started");
    }

    function stopTest() {
        if (theChuck) {
            theChuck.removeLastCode();
            console.log("Test stopped");
        }
    }

        async function runActualTest() {
            theChuck.startListeningForEvent("done", doneCallback);
            theChuck.startListeningForEvent("save", saveCallback);
            theChuck.runCode(`
                SinOsc osc1 => dac.chan(0);
                330 => osc1.freq;
                SinOsc osc2 => dac.chan(1);
                660 => osc2.freq;
                global Event done;
                global Event save;
                global Event sectionone;
                global Event sectiontwo;
                global Event sectionthree;
                global Event KeyO;
                global Event KeyE;
                time O[0];
                time E[0];
                int counterleft1;
                int counterright1;
                int counterleft2;
                int counterright2;
                int counterleft3;
                int counterright3;

                fun void one(){
                    repeat(21){
                        1 => osc1.gain;
                        .2::second => now;
                        0 => osc1.gain;
                        .2::second => now;
                    }
                }

                fun void two(){
                    repeat(14){
                        1 => osc2.gain;
                        .3::second => now;
                        0 => osc2.gain;
                        .3::second => now;
                    }
                }

                fun void oneA(){
                    repeat(30){
                        1 => osc1.gain;
                        .15::second => now;
                        0 => osc1.gain;
                        .15::second => now;
                    }
                }

                fun void twoB(){
                    repeat(15){
                        1 => osc2.gain;
                        .3::second => now;
                        0 => osc2.gain;
                        .3::second => now;
                    }
                }

                fun void oneC(){
                    repeat(20){
                        1 => osc1.gain;
                        .3::second => now;
                        0 => osc1.gain;
                        .3::second => now;
                    }
                }

                fun void twoD(){
                    repeat(15){
                        1 => osc2.gain;
                        .4::second => now;
                        0 => osc2.gain;
                        .4::second => now;
                    }
                }

                time eventTimesLeft1[16], eventTimesRight1[16];
                time eventTimesLeft2[16], eventTimesRight2[16];
                time eventTimesLeft3[16], eventTimesRight3[16];

                global float resultLeft1, resultRight1;
                global float resultLeft2, resultRight2;
                global float resultLeft3, resultRight3;

                fun float calculateAverageInterval(time eventTimes[]) {
                    time totalInterval;
                    0 => totalInterval;
                    for (int i = 0; i < eventTimes.size() - 1; i++) {
                        totalInterval += (eventTimes[i+1] - eventTimes[i]);
                    }
                    return (totalInterval / samp) / (eventTimes.size() - 1);
                }

                fun void lefthandfirstexercise() {
                    int i = 0;
                    while (i < eventTimesLeft1.size()) {
                        E << now;
                        KeyE => now;
                        now => eventTimesLeft1[i];
                        i++;
                    }
                }

                fun void righthandfirstexercise() {
                    int i = 0;
                    while (i < eventTimesRight1.size()) {
                        O << now;
                        KeyO => now;
                        now => eventTimesRight1[i];
                        i++;
                    }
                    sectionone.broadcast();
                }

                fun void lefthandsecondexercise() {
                    int i = 0;
                    while (i < eventTimesLeft2.size()) {
                        E << now;
                        KeyE => now;
                        now => eventTimesLeft2[i];
                        i++;
                    }
                }

                fun void righthandsecondexercise() {
                    int i = 0;
                    while (i < eventTimesRight2.size()) {
                        O << now;
                        KeyO => now;
                        now => eventTimesRight2[i];
                        i++;
                    }
                    sectiontwo.broadcast();
                }

                fun void lefthandthirdexercise() {
                    int i = 0;
                    while (i < eventTimesLeft3.size()) {
                        E << now;
                        KeyE => now;
                        now => eventTimesLeft3[i];
                        i++;
                    }
                }

                fun void righthandthirdexercise() {
                    int i = 0;
                    while (i < eventTimesRight3.size()) {
                        O << now;
                        KeyO => now;
                        now => eventTimesRight3[i];
                        i++;
                    }
                    sectionthree.broadcast();
                }

                spork ~ lefthandfirstexercise();
                spork ~ righthandfirstexercise();
                sectionone => now;
                resultLeft1 = calculateAverageInterval(eventTimesLeft1);
                resultRight1 = calculateAverageInterval(eventTimesRight1);

                spork ~ lefthandsecondexercise();
                spork ~ righthandsecondexercise();
                sectiontwo => now;
                resultLeft2 = calculateAverageInterval(eventTimesLeft2);
                resultRight2 = calculateAverageInterval(eventTimesRight2);

                spork ~ lefthandthirdexercise();
                spork ~ righthandthirdexercise();
                sectionthree => now;
                resultLeft3 = calculateAverageInterval(eventTimesLeft3);
                resultRight3 = calculateAverageInterval(eventTimesRight3);

                done.broadcast();
                second => now;
                save.broadcast();
                eon => now;
            `);
        }

        function sendForm() {
            fname = document.getElementById('fname').value;
            lname = document.getElementById('lname').value;
        }

        function doneCallback() {
            theChuck.getFloat("resultLeft1").then(val => left1 = val);
            theChuck.getFloat("resultLeft2").then(val => left2 = val);
            theChuck.getFloat("resultLeft3").then(val => left3 = val);
            theChuck.getFloat("resultRight1").then(val => right1 = val);
            theChuck.getFloat("resultRight2").then(val => right2 = val);
            theChuck.getFloat("resultRight3").then(val => right3 = val);
        }

        function saveCallback() {
            document.getElementById('test').innerHTML = `
                <div class="container-md mt-3 border">
                    <p class="h4 text-center"><b>Thank you</b><br>Upload your results (downloaded as a .json) to canvas</p>
                </div>
            `;
            JSONToFile({
                name: fname,
                lastName: lname,
                referenceleft1: 8820,
                referenceright1: 13230,
                resultleft1: left1,
                resultright1: right1,
                referenceleft2: 6615,
                referenceright2: 13230,
                resultleft2: left2,
                resultright2: right2,
                referenceleft3: 13230,
                referenceright3: 17640,
                resultleft3: left3,
                resultright3: right3
            }, 'tempo_recall' + fname + lname);
        }

        function JSONToFile(obj, filename) {
            const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.addEventListener("DOMContentLoaded", async function() {
        await initChuck();
        document.addEventListener("keypress", function(event) {
            if (event.code === 'KeyE') {
                theChuck.broadcastEvent("KeyE");
            }
            if (event.code === 'KeyO') {
                theChuck.broadcastEvent("KeyO");
            }
        });
    });

    window.startTest = startTest;
    window.stopTest = stopTest;
    window.runActualTest = runActualTest;
    window.sendForm = sendForm;
</script>
</head>
<body>
    <div class="container-md mt-3 border" id="intro">
        <p class="h1 text-center">How well do musicians retain multiple tempos?</p>
        <p class="h4 text-center"><b>WARNING</b> use earpods or headphones</p>
        <p class="h5 text-center">Take the volume of your computer all the way down, then press the "Start Test" button and increase the volume until you reach a comfortable level.</p>
        <div class="row">
            <div class="col"></div>
            <div class="col">
                <div class="col"><button id="action" class="btn btn-primary" onclick="startTest().catch(console.error)">Start Test</button>
                <button id="stopTest" class="btn btn-primary" onclick="stopTest()">Stop Test</button>
            </div>
            <div class="col"></div>
        </div>
        <div class="input-group input-group-md mb-3">
            <form id="myForm">
                <label for="fname">First name:</label>
                <input type="text" id="fname" name="fname" required><br><br>
                <label for="lname">Last name:</label>
                <input type="text" id="lname" name="lname" required><br><br>
                <button type="button" class="btn btn-primary" onclick="sendForm(); document.getElementById('intro').style.display='none'; document.getElementById('test').style.display='block';">Submit</button>
            </form>
        </div>
    </div>

    <div class="container-md mt-3 border" id="test" style="display:none;">
        <p class="h4 text-center"><b>WARNING</b> After you hit start don't change the volume of your device</p>
        <p class="h5 text-center">When you press 'start' you will hear two tempos played at the same time, one in each ear, for fifteen ticks. When the last tick stops use the E key for the left ear and O key for the right ear to keep tapping at the same tempo. After 16 taps the computer tick will start again at a new tempo. Repeat three times. The experiment will end by itself after the third set.</p>
        <div class="row" id="frame">
            <div class="col"></div>
            <div class="col">
                <button id="actualTest" class="btn btn-primary" onclick="this.disabled=true; runActualTest();">Start Test</button>
            </div>
            <div class="col"></div>
        </div>
    </div>
</body>
</html>
